{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "osm-dash",
    "Parameters": {
        "GitSha": {
            "Type": "String"
        },
        "Bucket": {
            "Type": "String",
            "Default": ""
        },
        "SlugPrefix": {
            "Type": "String",
            "Default": "slugs/osm-dash/"
        },
        "OutputPrefix": {
            "Type": "String",
            "Default": "osm-dash/"
        },
        "Environment": {
            "Type": "String",
            "Default": "staging"
        },
        "ReplicationPath": {
            "Type": "String",
            "Default": "http://planet.osm.org/replication/"
        }
    },
    "Resources": {
        "LambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "lambda.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }]
                },
                "Path": "/stack/lambda/",
                "Policies": [{
                    "PolicyName": "osm-dash",
                    "PolicyDocument": {
                        "Statement": [{
                            "Action": [
                                "dynamodb:*"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "MainTable",
                                    "Arn"
                                ]
                            }
                        }, {
                            "Action": [
                                "cloudwatch:PutMetricData",
                                "cloudwatch:GetMetricStatistics"
                            ],
                            "Effect": "Allow",
                            "Resource": "*"
                        }, {
                            "Effect": "Allow",
                            "Action": [
                                "logs:*"
                            ],
                            "Resource": "arn:aws:logs:*:*:*"
                        }, {
                            "Effect": "Allow",
                            "Action": [
                                "s3:DeleteObject",
                                "s3:GetObject",
                                "s3:GetObjectAcl",
                                "s3:PutObject",
                                "s3:PutObjectAcl"
                            ],
                            "Resource": [{
                                "Fn::Join": [
                                    "", [
                                        "arn:aws:s3:::",
                                        {
                                            "Ref": "Bucket"
                                        },
                                        "/osm-dash/*"
                                    ]
                                ]
                            }]
                        }, {
                            "Action": [
                                "sqs:ChangeMessageVisibility",
                                "sqs:ChangeMessageVisibilityBatch",
                                "sqs:DeleteMessage",
                                "sqs:ReceiveMessage",
                                "sqs:SendMessage",
                                "sqs:SendMessageBatch"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "perMinQueue",
                                    "Arn"
                                ]
                            }
                        }, {
                            "Action": [
                                "sqs:ChangeMessageVisibility",
                                "sqs:ChangeMessageVisibilityBatch",
                                "sqs:DeleteMessage",
                                "sqs:ReceiveMessage",
                                "sqs:SendMessage",
                                "sqs:SendMessageBatch"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "perTenMinQueue",
                                    "Arn"
                                ]
                            }
                        }]
                    }
                }]
            }
        },
        "FetcherLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description": "Fetches, parses, and writes metrics for the current minutely OSM file, every minute.",
                "Code": {
                    "S3Bucket": {
                        "Ref": "Bucket"
                    },
                    "S3Key": {
                        "Fn::Join": [
                            "", [{
                                    "Ref": "SlugPrefix"
                                },
                                {
                                    "Ref": "GitSha"
                                },
                                ".zip"
                            ]
                        ]
                    }
                },
                "FunctionName": {
                    "Fn::Join": [
                        "", [
                            "osm-dash-fetcher-",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "Handler": "fetcher.handler",
                "Runtime": "nodejs6.10",
                "Timeout": 150,
                "MemorySize": 128,
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "Bucket": {
                            "Ref": "Bucket"
                        },
                        "GitSha": {
                            "Ref": "GitSha"
                        },
                        "Environment": {
                            "Ref": "Environment"
                        },
                        "ReplicationPath": {
                            "Ref": "ReplicationPath"
                        },
                        "MainTable": {
                            "Ref": "MainTable"
                        },
                        "perMinQueue": {
                            "Ref": "perMinQueue"
                        }
                    }
                }
            }
        },
        "FetcherInvokePermissions": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Fn::GetAtt": [
                        "FetcherLambda",
                        "Arn"
                    ]
                },
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "FetcherLambdaTrigger",
                        "Arn"
                    ]
                }
            }
        },
        "FetcherLambdaTrigger": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "ScheduleExpression": "rate(1 minute)",
                "State": "ENABLED",
                "Targets": [{
                    "Id": "FetcherLambda",
                    "Arn": {
                        "Fn::GetAtt": [
                            "FetcherLambda",
                            "Arn"
                        ]
                    }
                }]
            }
        },
        "AggregatorLambda": {
            "Type": "AWS::Lambda::Function",
            "Description": "Aggregates metrics spanning various time ranges.",
            "Properties": {
                "Code": {
                    "S3Bucket": {
                        "Ref": "Bucket"
                    },
                    "S3Key": {
                        "Fn::Join": [
                            "", [{
                                    "Ref": "SlugPrefix"
                                },
                                {
                                    "Ref": "GitSha"
                                },
                                ".zip"
                            ]
                        ]
                    }
                },
                "FunctionName": {
                    "Fn::Join": [
                        "", [
                            "osm-dash-aggregator-",
                            {
                                "Ref": "Environment"
                            }
                        ]
                    ]
                },
                "Handler": "aggregator.handler",
                "Runtime": "nodejs6.10",
                "Timeout": 300,
                "MemorySize": 128,
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "Bucket": {
                            "Ref": "Bucket"
                        },
                        "GitSha": {
                            "Ref": "GitSha"
                        },
                        "Environment": {
                            "Ref": "Environment"
                        },
                        "MainTable": {
                            "Ref": "MainTable"
                        },
                        "perMinQueue": {
                            "Ref": "perMinQueue"
                        },
                        "perTenMinQueue": {
                            "Ref": "perTenMinQueue"
                        }
                    }
                }
            }
        },
        "MainTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "AttributeDefinitions": [{
                    "AttributeName": "parent",
                    "AttributeType": "S"
                }, {
                    "AttributeName": "sequence",
                    "AttributeType": "N"
                }],
                "KeySchema": [{
                    "AttributeName": "parent",
                    "KeyType": "HASH"
                }, {
                    "AttributeName": "sequence",
                    "KeyType": "RANGE"
                }],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": 1,
                    "WriteCapacityUnits": 1
                }
            }
        },
        "perMinQueue": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "ContentBasedDeduplication": true,
                "FifoQueue": true,
                "MessageRetentionPeriod": 1209600,
                "ReceiveMessageWaitTimeSeconds": 20
            }
        },
        "perTenMinQueue": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "ContentBasedDeduplication": true,
                "FifoQueue": true,
                "MessageRetentionPeriod": 1209600,
                "ReceiveMessageWaitTimeSeconds": 0
            }
        },
        "perMinInvokePermissions": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Fn::GetAtt": [
                        "AggregatorLambda",
                        "Arn"
                    ]
                },
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "perMinAggregatorTrigger",
                        "Arn"
                    ]
                }
            }
        },
        "perMinAggregatorTrigger": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "ScheduleExpression": "rate(1 minute)",
                "State": "ENABLED",
                "Targets": [{
                    "Id": "AggregatorLambda",
                    "Input": "{\"source\":\"perMinTrigger\"}",
                    "Arn": {
                        "Fn::GetAtt": [
                            "AggregatorLambda",
                            "Arn"
                        ]
                    }
                }]
            }
        },
        "perTenMinInvokePermissions": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Fn::GetAtt": [
                        "AggregatorLambda",
                        "Arn"
                    ]
                },
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "perTenMinAggregatorTrigger",
                        "Arn"
                    ]
                }
            }
        },
        "perTenMinAggregatorTrigger": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "ScheduleExpression": "rate(10 minutes)",
                "State": "ENABLED",
                "Targets": [{
                    "Id": "AggregatorLambda",
                    "Input": "{\"source\":\"perTenMinTrigger\"}",
                    "Arn": {
                        "Fn::GetAtt": [
                            "AggregatorLambda",
                            "Arn"
                        ]
                    }
                }]
            }
        }
    },
    "Outputs": {
        "SlugLocation": {
            "Value": {
                "Fn::Join": [
                    "", [{
                            "Ref": "Bucket"
                        },
                        "/",
                        {
                            "Ref": "SlugPrefix"
                        },
                        {
                            "Ref": "GitSha"
                        },
                        ".zip"
                    ]
                ]
            }
        }
    }
}
